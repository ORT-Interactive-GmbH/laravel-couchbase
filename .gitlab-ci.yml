image: php

services:
  - mysql:latest

variables:
  MYSQL_DATABASE: testing
  MYSQL_ROOT_PASSWORD: secret
  MYSQL_HOST: mysql

cache:
  paths:
    - vendor/

before_script:
  - set -e

  - apt-get update -yqq
  - apt-get install wget -yqq

  # Install dependencies
  - apt-get install git libxml2-dev libexpat1-dev libbz2-dev libgmp3-dev libldap2-dev unixodbc-dev libpq-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev libtidy-dev -yqq
  - apt-get install lsb-release -yqq #libmcrypt-dev libcurl4-openssl-dev

  - curl -O http://packages.couchbase.com/releases/couchbase-release/couchbase-release-1.0-6-amd64.deb
  - dpkg -i ./couchbase-release-1.0-6-amd64.deb
  - apt-get update -yqq

  # Couchbase Server
  - bash setup_couchbase_server.sh

  # Install php extensions
  - docker-php-ext-install pdo_mysql json zip #mbstring mcrypt curl intl gd xml bz2 opcache
  - pecl install couchbase # couchbase-2.4.0 or above
  - docker-php-ext-enable couchbase

  # Install & enable Xdebug for code coverage reports
  - pecl install xdebug
  - docker-php-ext-enable xdebug

  # Install Composer and project dependencies.
  - curl -sS https://getcomposer.org/installer | php
  - php composer.phar install --prefer-dist --no-interaction

test:php7.1:cb5:
  variables:
    CB_DATABASE: "test-ing-cb5"
    CB_VERSION: 5
  image: php:7.1
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
  - docker

test:php7.1:cb6:
  variables:
    CB_DATABASE: "test-ing-cb6"
    CB_VERSION: 6
  image: php:7.1
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
  - docker

test:php7.2:cb5:
  variables:
    CB_DATABASE: "test-ing-cb5"
    CB_VERSION: 5
  image: php:7.2
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
    - docker

test:php7.2:cb6:
  variables:
    CB_DATABASE: "test-ing-cb6"
    CB_VERSION: 6
  image: php:7.2
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
    - docker

test:php7.3cb5:
  variables:
    CB_DATABASE: "test-ing-cb5"
    CB_VERSION: 5
  image: php:7.3
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
    - docker

test:php7.3:cb6:
  variables:
    CB_DATABASE: "test-ing-cb6"
    CB_VERSION: 6
  image: php:7.3
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
    - docker

test:php7.4cb5:
  variables:
    CB_DATABASE: "test-ing-cb5"
    CB_VERSION: 5
  image: php:7.4
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
    - docker

test:php7.4:cb6:
  variables:
    CB_DATABASE: "test-ing-cb6"
    CB_VERSION: 6
  image: php:7.4
  script:
    - php vendor/bin/phpunit --coverage-text --colors=never --coverage-clover=coverage.xml
  tags:
    - docker
